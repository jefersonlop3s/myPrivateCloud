version: '3'
services:
  app:
    image: nextcloud:latest
#    image: nextcloud:27.1.2-fpm-alpine
    restart: always
    networks:
      nextcloud-net:
        ipv4_address: 172.19.0.2
    expose:
      - "80"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /opt/nextcloud/html:/var/www/html:rw          # Altere o caminho para o volume html que ser√° utilizado pelo Nextcloud
      - /opt/nextcloud/data:/srv/nextcloud/data:rw    # Altere o caminho para o volume de dados
    user: "1000:1000"
    environment:
      - POSTGRES_HOST=$(cat /run/secrets/secrets.txt | grep POSTGRES_HOST | cut -d'=' -f2)
      - POSTGRES_DB=$(cat /run/secrets/secrets.txt | grep POSTGRES_DB | cut -d'=' -f2)
      - POSTGRES_USER=$(cat /run/secrets/secrets.txt | grep POSTGRES_USER | cut -d'=' -f2)
      - POSTGRES_PASSWORD=$(cat /run/secrets/secrets.txt | grep POSTGRES_PASSWORD | cut -d'=' -f2)
      - NEXTCLOUD_ADMIN_PASSWORD=$(cat /run/secrets/secrets.txt | grep NEXTCLOUD_ADMIN_PASSWORD | cut -d'=' -f2)
      - NEXTCLOUD_ADMIN_USER=$(cat /run/secrets/secrets.txt | grep NEXTCLOUD_ADMIN_USER | cut -d'=' -f2)
      - NEXTCLOUD_TRUSTED_DOMAINS=$(cat /run/secrets/secrets.txt | grep NEXTCLOUD_TRUSTED_DOMAINS | cut -d'=' -f2)
      - VIRTUAL_HOST=192.168.5.120 # IP do Host Local, Altere-o
    secrets:
      - secrets-file

  nginx:
    image: nginx:1.25.2-alpine
    container_name: nginx
    restart: always
    networks:
      nextcloud-net:
        ipv4_address: 172.19.0.5
    ports:
      - "80:80"
      - "443:443"
    links:
      - app
    environment:
      - TLS_CERT=/etc/tls/server.crt
      - TLS_KEY=/etc/tls/server.key
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./certs:/etc/tls
secrets:
  secrets-file:
    file: ./secrets.txt

networks:
  nextcloud-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.19.0.0/16